<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></link>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        var USER_EMAIL = '<?= userEmail ?>';
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: normal;
            font-size: 0.875rem;
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Pathway card selection */
        .path-card.selected {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.4);
        }

        /* Result box styling */
        .result-box.caution {
            background-color: #fffbeb;
            border-left-color: #f59e0b;
            color: #b45309;
        }
        .result-box.block {
            background-color: #fee2e2;
            border-left-color: #dc2626;
            color: #991b1b;
        }
        .result-box.go {
            background-color: #f0fdf4;
            border-left-color: #22c55e;
            color: #15803d;
        }

        /* Answer button styling for boolean questions */
        .answer-btn.yes.active { background-color: #16a34a; color: white; border-color: #16a34a; }
        .answer-btn.no.active { background-color: #dc2626; color: white; border-color: #dc2626; }
        .answer-btn.inactive { background-color: #f9fafb; color: #6b7280; }

        /* Back to top button */
        #back-to-top-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: none;
            transition: opacity 0.3s, visibility 0.3s;
            opacity: 0;
            visibility: hidden;
        }
        #back-to-top-btn.show {
            opacity: 1;
            visibility: visible;
        }

        /* Print-specific styles (for PDF generation, hides non-printable elements) */
        @media print {
            body * { visibility: hidden; }
            #printable-area, #printable-area * { visibility: visible; }
            #printable-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
            .no-print { display: none; }
            /* Add this to prevent elements from breaking across pages awkwardly if not handled by jsPDF */
            .path-card, .readiness-analysis-section, #checklist-column, aside {
                page-break-inside: avoid;
            }
        }
        /* Custom class for PDF (used to hide buttons during canvas capture) */
        .hide-for-pdf {
            display: none !important;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <div id="printable-area">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900">VCF 9.0 Adoption Readiness Application</h1>
                <p class="mt-2 text-lg text-gray-600">Unlock Your Private Cloud with VCF 9.0</p>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-8 bg-white p-4 rounded-lg shadow-sm no-print">
                <div class="lg:col-span-1 grid grid-cols-1 gap-4">
                    <div>
                        <label for="customer-name" class="block text-sm font-medium text-gray-700">Customer Name</label>
                        <input type="text" id="customer-name" placeholder="Enter customer or project name..." class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div id="assessed-by-email-display" class="text-sm text-gray-600 mt-2">
                    </div>
                    <div id="submission-id-display" class="text-sm text-gray-600 mt-2">
                    </div>
                </div>

                <div class="lg:col-span-2 flex flex-col justify-center items-stretch lg:items-end mt-4 lg:mt-0">
                    <div class="flex flex-col sm:flex-row sm:justify-end gap-3 w-full">
                        <button id="save-to-sheet-btn" class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:bg-gray-400">
                            <i id="save-icon" class="fa-solid fa-cloud-upload mr-2"></i>
                            <span id="save-btn-text">Submit</span>
                        </button>
                        <button id="download-pdf-btn" class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-gray-400">
                            <i class="fa-solid fa-file-pdf mr-2"></i> <span id="download-pdf-btn-text">Download as PDF</span>
                        </button>
                        <button id="download-customer-summary-btn" class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400">
                            <i class="fa-solid fa-file-alt mr-2"></i> <span id="download-customer-summary-btn-text">Customer Summary (TXT)</span>
                        </button>
                        <button id="download-checklist-pdf-btn" class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 disabled:bg-gray-400 no-print">
                            <i class="fa-solid fa-file-pdf mr-2"></i> Checklist PDF
                        </button>
                        <button id="download-analysis-pdf-btn" class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 disabled:bg-gray-400 no-print">
                            <i class="fa-solid fa-file-pdf mr-2"></i> Analysis PDF
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 text-right">Note: Assessment data is saved to a sheet named 'Assessment Log' in the host Google Sheet.</p>
                </div>
            </div>

            <section id="path-selection" class="mb-8">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">1. Select Your Pathway</h2>
                <div id="path-cards-container" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-3 gap-6"></div>
            </section>

            <section id="readiness-analysis-section" class="hidden mb-8 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Readiness Analysis</h2>
                <div id="readiness-summary" class="mt-4"></div>
            </section>

            <main id="main-content" class="grid grid-cols-1 lg:grid-cols-3 gap-8 hidden">
                <div id="checklist-column" class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                    <h2 id="checklist-title" class="text-2xl font-semibold mb-4 text-gray-800">2. Readiness Checklist</h2>
                    <div id="checklist-container" class="space-y-4"></div>
                </div>
                <aside class="bg-white p-6 rounded-lg shadow-md lg:sticky top-8 self-start">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">3. Key Considerations</h2>
                    <div id="info-panel-container" class="space-y-4"></div>
                </aside>
            </main>
        </div>
    </div>

    <button id="back-to-top-btn" class="no-print bg-indigo-600 text-white rounded-full shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 w-12 h-12 flex items-center justify-center">
        <i class="fa-solid fa-arrow-up"></i>
    </button>


    <script>
        const pathData = {
            'path1': {
                title: "Path 1: Deploy New VCF 9 Environment (Greenfield)",
                description: "Start fresh with a new VCF 9 deployment. Ideal for new projects, hardware refreshes, or when an in-place upgrade is too complex.",
                customer: {
                    title: "Customer Considerations",
                    details: [
                        { icon: 'fa-solid fa-server', text: '<strong>Lowest Risk:</strong> This path is the safest as your current production environment remains untouched during the build phase.' },
                        { icon: 'fa-solid fa-dollar-sign', text: '<strong>Highest Initial Cost:</strong> Requires capital expenditure for new hardware and running two environments in parallel during migration.' },
                        { icon: 'fa-solid fa-broom', text: '<strong>Clean Slate:</strong> Avoids carrying over legacy configuration issues or technical debt.' }
                    ]
                },
                delivery: {
                    title: "Delivery Considerations",
                    sections: [
                        { title: "Tools Involved", icon: "fa-solid fa-wrench", items: ["VCF Installer", "VMware HCX (Optional for migration)"] },
                        { title: "Design Options", icon: "fa-solid fa-sitemap", items: ["Appliance Model: Simple (lab) or HA (production)", "Fleet Topology: Single-Site or Multi-Site"] },
                        { title: "Key Implementation Activities", icon: "fa-solid fa-list-check", items: ["Deploy VCF Installer & run automated deployment", "Build Workload Domains", "Deploy & configure HCX for migration", "Execute migration waves", "License & Decommission"] },
                    ]
                },
                greenfieldQuestions: [
                    { id: "gf-hcl", text: "Does Customer have supported hardware for VCF 9 based on HCL? Yes or No", category: "Hardware", type: "boolean", yes: "You can Deploy VCF 9.0", no: "You cannot Deploy VCF 9.0" },
                    { id: "gf-storage", text: "What Primary Storage will be used to deploy VCF 9.0?", category: "Storage", type: "select",
                        options: [
                            { value: "vSAN ESA", result: "You can Deploy VCF 9.0" },
                            { value: "vSAN OSA", result: "You can Deploy VCF 9.0" },
                            { value: "Fibre Channel(FC)", result: "You can Deploy VCF 9.0" },
                            { value: "NFS", result: "You can Deploy VCF 9.0" },
                            { value: "Other", result: "You cannot Deploy VCF 9.0 with any other type of Storage Protocol vSAN ESA, vSAN OSA, Fibre Channel(FC), NFS" }
                        ]
                    },
                    { id: "gf-min-hosts", text: 'Have you confirmed that a minimum of 4 HCL-compliant ESXi hosts are available for the management domain? <span class="text-xs font-bold text-indigo-600 bg-indigo-100 px-2 py-1 rounded-full ml-2">NEW</span>', category: "Environment", type: "boolean", yes: "The minimum host count for the management domain is met.", no: "You cannot proceed. A minimum of 4 ESXi hosts is required for the VCF Management Domain." },
                    { id: "gf-redundant-switches", text: 'Are redundant physical network switches (e.g., ToR switches) in place for all VCF host connections? <span class="text-xs font-bold text-indigo-600 bg-indigo-100 px-2 py-1 rounded-full ml-2">NEW</span>', category: "Networking", type: "boolean", yes: "Redundant networking hardware is in place, reducing single points of failure.", no: "Deployment can proceed, but this is a high-risk configuration. Redundant switches are strongly recommended for production. -- Caution" },
                    { id: "gf-vlan-planning", text: 'Have all required VLANs (Management, vSAN, vMotion, etc.) and their corresponding subnets/IP pools been planned and documented? <span class="text-xs font-bold text-indigo-600 bg-indigo-100 px-2 py-1 rounded-full ml-2">NEW</span>', category: "Networking", type: "boolean", yes: "IP and VLAN planning is complete, which is a critical step for a successful bring-up.", no: "You cannot proceed. Complete and document all IP and VLAN planning before starting the deployment." },
                    { id: "gf-ntp", text: 'Are NTP servers available on the network, and have all planned components been configured for time synchronization? <span class="text-xs font-bold text-indigo-600 bg-indigo-100 px-2 py-1 rounded-full ml-2">NEW</span>', category: "Environment", type: "boolean", yes: "Proper time synchronization is configured, which is essential for stable operations.", no: "You cannot proceed. Consistent NTP is mandatory for all VCF components." },
                    { id: "gf-dns", text: 'Has DNS been configured with both Forward (A) and Reverse (PTR) lookup records for all planned VCF components (SDDC Manager, vCenter, NSX, Hosts)? <span class="text-xs font-bold text-indigo-600 bg-indigo-100 px-2 py-1 rounded-full ml-2">NEW</span>', category: "Environment", type: "boolean", yes: "DNS is correctly configured, which is required for component communication.", no: "You cannot proceed. Fully functional DNS with both forward and reverse lookups is mandatory." },
                    { id: "gf-software", text: 'Have all required VCF 9.0 software components (Cloud Builder, ESXi ISOs, etc.) been downloaded from the Broadcom support portal? <span class="text-xs font-bold text-indigo-600 bg-indigo-100 px-2 py-1 rounded-full ml-2">NEW</span>', category: "Software", type: "boolean", yes: "All necessary software is downloaded and ready for deployment.", no: "Please download all required software from the VCF 9.0 Bill of Materials (BOM) before proceeding." },
                    { id: "gf-licenses", text: 'Are all necessary VCF 9.0 licenses (VCF, vSphere, vSAN, NSX) available and documented? <span class="text-xs font-bold text-indigo-600 bg-indigo-100 px-2 py-1 rounded-full ml-2">NEW</span>', category: "Licensing", type: "boolean", yes: "All required licenses are available.", no: "You cannot deploy VCF 9.0 without the appropriate licenses. Please acquire them first." },
                    { id: "gf-backup", text: 'Do you have a documented backup strategy for critical components (SDDC Manager, vCenter, NSX) that will be implemented immediately after deployment? <span class="text-xs font-bold text-indigo-600 bg-indigo-100 px-2 py-1 rounded-full ml-2">NEW</span>', category: "Operations", type: "boolean", yes: "A day-one backup strategy is planned, which is critical for operational readiness.", no: "It is highly recommended to have a backup plan ready before deployment to avoid data loss risk. -- Caution" }
                ]
            },
            'path2': {
                title: "Path 2: Upgrade Existing VMware Environment to VCF 9 (Brownfield)",
                description: "Convert your existing VMWare vSphere environment into a full VCF 9 Fleet, leveraging your current hardware.",
                customer: {
                    title: "Customer Considerations",
                    details: [
                        { icon: 'fa-solid fa-triangle-exclamation', text: '<strong>Caution:</strong> The conversion process is complex and intrusive. A failure during a critical step can lead to significant downtime.' },
                        { icon: 'fa-solid fa-piggy-bank', text: '<strong>Lower Hardware Cost:</strong> Leverages existing hardware, avoiding a major new purchase.' },
                        { icon: 'fa-solid fa-list-ol', text: '<strong>Mandatory Prerequisites:</strong> This path is not possible unless all remediation steps (Break ELM, Convert to vLCM Images) are completed.' }
                    ]
                },
                delivery: {
                    title: "Delivery Considerations",
                    sections: [
                        { title: "Tools Involved", icon: "fa-solid fa-wrench", items: ["vCenter Installer & Lifecycle Manager", "VCF Installer", "VCF Operations & Import Tool", "Aria Suite Lifecycle (if applicable)"] },
                        { title: "Design Options", icon: "fa-solid fa-sitemap", items: ["Appliance Model: Simple or HA", "Fleet Topology: Single-Site or Multi-Site"] },
                        { title: "Key Implementation Activities", icon: "fa-solid fa-list-check", items: ["Perform sequenced Aria/vSphere upgrades", "Remediate: Break ELM & Remove IWA", "Convert clusters to vLCM Images", "Run pre-checks & execute conversion", "License & Validate"] },
                    ]
                },
                genericQuestions: [
                    { id: "g-hw", text: "Have you reviewed the Broadcom Compatibility Guide (BCG) Hardware List for any incompatibility issues (https://compatibilityguide.broadcom.com/)? Yes or No", category: 'Hardware', type: "boolean", yes: "You can upgrade to VCF 9.0", no: "You cannot upgrade to VCF 9.0, because of incompatibility hardware" },
                    { id: "g-vxrail", text: "Is VXRAIL hardware deployed in environment and apart VCF Upgrade Plan? Yes or No", category: 'Hardware', type: "boolean", yes: "You cannot upgrade to VCF 9.0, because VXRAIL Hardware is not supported for upgrade", no: "You can upgrade to VCF 9.0" },
                    { id: "g-powerflex", text: "Is Dell PowerFlex being used in environment? Yes or No", category: 'Hardware', type: "boolean", yes: "You can upgrade to VCF 9.0, but be aware that RPQ is required for storage. -- Caution", no: "You can upgrade to VCF 9.0" },
                    { id: "g-vcd", text: "Is vCloud Director being used in the environment? Yes or No", category: 'Integration', type: "boolean", yes: "You cannot upgrade to VCF 9.0, because vCloud Director is not supported in VCF 9", no: "You can upgrade to VCF 9.0" },
                    { id: "g-vvol", text: "Is vVOL storage being used in environment?", category: 'Hardware', type: "boolean", yes: "You can upgrade to VCF 9.0, but be aware that vVOLs will be deprecated in a future release. -- Caution", no: "You can upgrade to VCF 9.0" },
                    { id: "g-firmware", text: 'Have you verified that all server firmware and BIOS versions are compliant with the versions specified in the VCF 9.0 Hardware Compatibility List (HCL)? <span class="text-xs font-bold text-indigo-600 bg-indigo-100 px-2 py-1 rounded-full ml-2">NEW</span>', category: "Hardware", type: "boolean", yes: "Firmware and BIOS levels are confirmed to be compatible.", no: "You cannot proceed with the upgrade. All hardware firmware and BIOS must be updated to HCL-compliant versions first." },
                    { id: "g-backup", text: 'Have you established a post-upgrade backup plan and verified that your current backup solution is compatible with the new VCF 9.0 component versions? <span class="text-xs font-bold text-indigo-600 bg-indigo-100 px-2 py-1 rounded-full ml-2">NEW</span>', category: "Operations", type: "boolean", yes: "A post-upgrade backup strategy is in place.", no: "It is highly recommended to validate your backup plan and software compatibility before starting the upgrade. -- Caution" }
                ],
                subPaths: {
                    vsphere: {
                        title: "vSphere",
                        questions: [
                            { id: "vs-ver", text: "Is vSphere on 8.x or above?", category: "Core vSphere", type: "boolean", yes: "You can upgrade to VCF 9.0", no: "You cannot upgrade to VCF 9.0. Upgrade to 8.x or above. If hardware is not compatible, then new hardware will need to be acquired." },
                            { id: "vs-elm", text: "Is Enhanced Linked Mode (ELM)/Shared vSphere SSO Domain being used?", category: "Core vSphere", type: "boolean", yes: "You can upgrade to VCF 9.0, but be aware that the ELM ring for each vCenter will need to be broken before going to VCF. (https://knowledge.broadcom.com/external/article/370062/splitting-enhanced-linked-mode-elm.html) -- Caution", no: "You can upgrade to VCF 9.0" },
                            { id: "vs-iwa", text: "Is IWA (Integrated Windows Authentication) being used?", category: "Core vSphere", type: "boolean", yes: "You can upgrade to VCF 9.0, but be aware that vCenter(s) will need to be updated to a new Identity Source. -- Caution", no: "You can upgrade to VCF 9.0" },
                            { id: "vs-vum", text: "Is vSphere Update Manager (VUM) being used in environment?", category: "Core vSphere", type: "boolean", yes: "You can upgrade to VCF 9.0, be aware that all clusters will need to be converted to VMware Lifecycle Manager(vLCM). (https://techdocs.broadcom.com/us/en/vmware-cis/vsphere/vsphere/8-0/managing-host-and-cluster-lifecycle-8-0/using-images-to-install-and-update-esxi-hosts-and-clusters/switching-from-baselines-to-images.html#GUID-B54663AB-B1D1-4E87-8B8C-76FF2998A477-en) -- Caution", no: "You can upgrade to VCF 9.0" },
                            { id: "vs-vcha", text: "Is vCenter High Availability Configured on vCenter(s)?", category: "Core vSphere", type: "boolean", yes: "You can upgrade to VCF 9.0, be aware that vCenter High Availability will need to be removed and added back after VCF upgrade is complete -- Caution", no: "You can upgrade to VCF 9.0" },
                            { id: "vs-hp", text: "Are vSphere Host Profiles being used?", category: "Core vSphere", type: "boolean", yes: "You can upgrade to VCF 9.0, but be aware that Host Profiles will be deprecated in a future release. -- Caution", no: "You can upgrade to VCF 9.0" },
                            { id: "vs-dload", text: "Are OBTU or UMDS download tools being used for vSphere in the current environment?", category: "Core vSphere", type: "boolean", yes: "You can upgrade to VCF 9.0, but be aware that OBTU and UMDS will be deprecated in a future release. -- Caution", no: "You can upgrade to VCF 9.0" },
                            { id: "vs-auto", text: "Is vCenter auto-deploy being used today?", category: "Core vSphere", type: "boolean", yes: "You can upgrade to VCF 9.0, but be aware that auto-deploy will be deprecated in a future release. -- Caution", no: "You can upgrade to VCF 9.0" },
                        ]
                    },
                    nsx: {
                        title: "NSX",
                        questions: [
                            { id: "nsx-vsmgmt", text: "Is vCenter that will be upgrade to be VCF Management Domain connected to a NSX Manager?", category: "NSX", type: "boolean", yes: "You cannot upgrade to VCF 9.0, vCenter with NSX Manager(s) cannot be upgraded to a management domain but can but imported as a workload domain.", no: "You can upgrade to VCF 9.0" },
                            { id: "nsx-elm1", text: "Is NSX Manager(s) connected to two or more vCenters with ELM configured?", category: "NSX", type: "boolean", yes: "You cannot upgrade to VCF 9.0, vCenter with ELM configured and connected to NSX Manager(s) cannot be imported as a workload domain.", no: "You can upgrade to VCF 9.0" },
                            { id: "nsx-fed", text: "Is NSX configured with NSX Federation?", category: "NSX", type: "boolean", yes: "You can upgrade to VCF 9.0, but be aware this could have impact on networks supported in NSX Federation, NSX Firewall Rules, Security Groups, etc.. -- Caution", no: "You can upgrade to VCF 9.0" },
                            { id: "nsx-bare", text: "Are there any Bare Metal Edges deployed?", category: "NSX", type: "boolean", yes: "You can upgrade to VCF 9.0, but be aware that all Bare Metal NSX Edges will need to be removed and replaced wtih new Virtual Edges. -- Caution", no: "You can upgrade to VCF 9.0" },
                        ]
                    },
                    aria_lm: {
                        title: "Aria Suite LM",
                        questions: [
                            { id: "alm-ver", text: "Is Aria Suite Lifecycle Manager at version 8.18 or above?", category: "Aria", type: "boolean", yes: "You can upgrade to VCF 9.0, but be aware that Patch 2 will need to be applied before upgrade of VCF 9.0 -- Caution", no: "You can upgrade to VCF 9.0, but be aware that Aria Suite Lifecycle Manager will need to be upgraded to version 8.18 Patch 2. -- Caution" }
                        ]
                    },
                    aria_ops: {
                        title: "Aria Operations",
                        questions: [
                            { id: "aops-ver", text: "Is Aria Operations at version 8.18.x or above?", category: "Aria", type: "boolean", yes: "You can upgrade to VCF 9.0", no: "You can upgrade to VCF 9.0, but be aware Aria Operations will need to be upgraded to 8.18 or above. -- Caution" },
                            { id: "aops-multi", text: "Is there more than one Aria Operations Deployed?", category: "Aria", type: "boolean", yes: "You can upgrade to VCF 9.0, but be aware that a VCF Fleet only supports one Aria Operations Instance, so customer will have to decided on multiple fleets, consolidation of instance or have operations not managed by a fleet. -- Caution", no: "You can upgrade to VCF 9.0" }
                        ]
                    },
                    aria_auto: {
                        title: "Aria Automation",
                        questions: [
                            { id: "aauto-ver", text: "Is Aria Automation on 8.18.x or above?", category: "Aria", type: "boolean", yes: "You can upgrade to VCF 9.0", no: "You can upgrade to VCF 9.0, but be aware Aria Automation will need to be upgraded to 8.18 or above. -- Caution" },
                            { id: "aauto-multi", text: "Is there more than one Aria Automation Deployed?", category: "Aria", type: "boolean", yes: "You can upgrade to VCF 9.0, but be aware of a VCF Fleet only supports one Automation Instances in integrated mode, all other instances will be none integrated instances( still can be Upgrades through Fleet Manager but not certificate or password managed -- Caution", no: "You can upgrade to VCF 9.0" }
                        ]
                    },
                    aria_ops_networks: {
                        title: "Aria Operations for Networks",
                        questions: [
                            { id: "aops-net-ver", text: "Is Aria Operations for Networks on 6.13 or above?", category: "Aria", type: "boolean", yes: "Deploy VCF", no: "Upgrade Aria Operations for Networks to 6.13 or higher" },
                            { id: "aops-net-multi", text: "Is there more than one Aria Operations for Networks Deployed?", category: "Aria", type: "boolean", yes: "Deploy VCF but be aware of a VCF Fleet only supports one Aria Operations for Networks Instances being added to the VCF Fleet , so customer will have to decided on multiple fleets or have operations for networks not managed by a Fleet -- Caution", no: "Deploy VCF" }
                        ]
                    },
                    aria_ops_logs: {
                        title: "Aria Operations for Logs",
                        questions: [
                           { id: "aops-logs-multi", text: "Is there more than one Aria Operations for Logs Deployed?", category: "Aria", type: "boolean", yes: "Deploy VCF but be aware of Aria Operations Logs does not get upgrade, it is new appliances, customers can keep old log appliances and migrate to new appliances over time -- Caution", no: "Deploy VCF" }
                        ]
                    }
                }
            },
            'path3': { // NEW PATH 3
                title: "Path 3: Upgrade Existing VCF 5.x to VCF 9.0",
                description: "Upgrade your existing VCF 5.x environment directly to VCF 9.0. This path is for customers already running VCF and seeking an in-place version upgrade.",
                customer: {
                    title: "Customer Considerations",
                    details: [
                        { icon: 'fa-solid fa-bolt', text: '<strong>Direct Upgrade Path:</strong> A more streamlined upgrade if your current VCF version is 5.0 or higher.' },
                        { icon: 'fa-solid fa-shield-alt', text: '<strong>Requires Prerequisites:</strong> Ensure all components meet the minimum version and configuration requirements for VCF 9.0 before starting.' },
                        { icon: 'fa-solid fa-hourglass-half', text: '<strong>Downtime Considerations:</strong> Plan for potential downtime during upgrade sequences for various components (e.g., SDDC Manager, vCenter, NSX, Workload Domains).' }
                    ]
                },
                delivery: {
                    title: "Delivery Considerations",
                    sections: [
                        { title: "Tools Involved", icon: "fa-solid fa-wrench", items: ["SDDC Manager", "vCenter Server Lifecycle Manager", "NSX-T Manager"] },
                        { title: "Design Options", icon: "fa-solid fa-sitemap", items: ["Review VCF 9.0 reference architecture updates", "Assess networking and storage compatibility and changes", "Plan for new features and components in VCF 9.0"] },
                        { title: "Key Implementation Activities", icon: "fa-solid fa-list-check", items: ["Review VCF 9.0 upgrade bundles and release notes", "Execute pre-checks", "Perform sequenced component upgrades via SDDC Manager (e.g., SDDC Manager, vCenter, NSX, vSphere, Workload Domains)", "Validate upgraded deployment and post-upgrade health checks"] },
                    ]
                },
                vcfUpgradeQuestions: [
                    { id: "vcf3-hcl", text: "Does Customer have supported hardware for VCF 9 based on HCL? Yes or No", category: "Hardware", type: "boolean", yes: "You can upgrade to VCF 9.0", no: "You cannot upgrade to VCF 9.0" },
                    { id: "vcf3-version", text: "Is Customer running VCF 5.0 or higher? Yes or No", category: "VCF Version", type: "boolean", yes: "You can upgrade to VCF 9.0", no: "You cannot upgrade to VCF 9.0" },
                    { id: "vcf3-vum", text: "Is vSphere Update Manager (VUM) being used in environment?", category: "Lifecycle Management", type: "boolean", yes: "You can upgrade to VCF 9.0 but be aware that all clusters will need to be converted to VMware Lifecycle Manager(vLCM) -- Caution", no: "You can upgrade to VCF 9.0" },
                    { id: "vcf3-firmware", text: 'Have you verified that all server firmware and BIOS versions are compliant with the versions specified in the VCF 9.0 Hardware Compatibility List (HCL)? <span class="text-xs font-bold text-indigo-600 bg-indigo-100 px-2 py-1 rounded-full ml-2">NEW</span>', category: "Hardware", type: "boolean", yes: "Firmware and BIOS levels are confirmed to be compatible.", no: "You cannot proceed with the upgrade. All hardware firmware and BIOS must be updated to HCL-compliant versions first." },
                    { id: "vcf3-backup", text: 'Have you established a post-upgrade backup plan and verified that your current backup solution is compatible with the new VCF 9.0 component versions? <span class="text-xs font-bold text-indigo-600 bg-indigo-100 px-2 py-1 rounded-full ml-2">NEW</span>', category: "Operations", type: "boolean", yes: "A post-upgrade backup strategy is in place.", no: "It is highly recommended to validate your backup plan and software compatibility before starting the upgrade. -- Caution" }
                ]
            }
        };

        const pathCardsContainer = document.getElementById('path-cards-container');
        const mainContent = document.getElementById('main-content');
        const checklistTitle = document.getElementById('checklist-title');
        const checklistContainer = document.getElementById('checklist-container');
        const infoPanelContainer = document.getElementById('info-panel-container');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const downloadPdfBtnText = document.getElementById('download-pdf-btn-text');
        const downloadCustomerSummaryBtn = document.getElementById('download-customer-summary-btn');
        const downloadCustomerSummaryBtnText = document.getElementById('download-customer-summary-btn-text');
        const saveToSheetBtn = document.getElementById('save-to-sheet-btn');
        const printableArea = document.getElementById('printable-area');
        const analysisSection = document.getElementById('readiness-analysis-section');
        const backToTopBtn = document.getElementById('back-to-top-btn');

        let questionnaireState = {};
        let selectedPathwayId = null;
        let isAssessmentSubmitted = false;
        let submissionId = null;

        function generateUniqueSubmissionId() {
            const timestamp = new Date().getTime();
            const random = Math.floor(Math.random() * 10000);
            return `VCF-${timestamp}-${random}`;
        }

        function initialize() {
            const assessedByEmailDisplay = document.getElementById('assessed-by-email-display');
            if (assessedByEmailDisplay && typeof USER_EMAIL !== 'undefined' && USER_EMAIL) {
                assessedByEmailDisplay.innerHTML = `<i class="fa-solid fa-user mr-2"></i> Assessed By: <strong>${USER_EMAIL}</strong>`;
            } else {
                assessedByEmailDisplay.style.display = 'none';
            }

            submissionId = generateUniqueSubmissionId();
            const submissionIdDisplay = document.getElementById('submission-id-display');
            if (submissionIdDisplay) {
                submissionIdDisplay.innerHTML = `<i class="fa-solid fa-id-badge mr-2"></i> Submission ID: <strong>${submissionId}</strong>`;
            }

            Object.keys(pathData).forEach(pathId => {
                const path = pathData[pathId];
                const card = document.createElement('div');
                card.className = 'path-card bg-white p-6 rounded-lg shadow-md cursor-pointer border-2 border-transparent hover:border-indigo-500 transition-all duration-300';
                card.dataset.pathId = pathId;
                card.innerHTML = `<h3 class="text-xl font-bold text-indigo-700">${path.title}</h3><p class="mt-2 text-gray-600">${path.description}</p>`;
                card.addEventListener('click', () => selectPath(pathId));
                pathCardsContainer.appendChild(card);
            });
            // Update grid for path cards container to accommodate 3 paths
            pathCardsContainer.classList.remove('md:grid-cols-2'); // Remove old class if it exists
            pathCardsContainer.classList.add('md:grid-cols-3'); // Add new class


            downloadPdfBtn.addEventListener('click', () => downloadPDF());
            downloadCustomerSummaryBtn.addEventListener('click', downloadCustomerSummary);
            saveToSheetBtn.addEventListener('click', saveDataToSheet);

            document.getElementById('download-checklist-pdf-btn').addEventListener('click', () => {
                downloadPDF('checklist-column', 'VCF9_Readiness_Checklist');
            });
            document.getElementById('download-analysis-pdf-btn').addEventListener('click', () => {
                downloadPDF('readiness-analysis-section', 'VCF9_Readiness_Analysis');
            });

            downloadPdfBtn.disabled = true;
            downloadCustomerSummaryBtn.disabled = true;
            document.getElementById('download-checklist-pdf-btn').disabled = true;
            document.getElementById('download-analysis-pdf-btn').disabled = true;

            window.addEventListener('scroll', () => {
                if (window.scrollY > 300) {
                    backToTopBtn.classList.add('show');
                } else {
                    backToTopBtn.classList.remove('show');
                }
            });
            backToTopBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }

        function saveStateToLocalStorage() {
            localStorage.setItem('selectedPathwayId', selectedPathwayId);
             if (selectedPathwayId === 'path2') {
                const checkedSubpaths = Array.from(document.querySelectorAll('.subpath-checkbox:checked')).map(cb => cb.value);
                localStorage.setItem('selectedSubPaths', JSON.stringify(checkedSubpaths));
            }
        }

        function loadStateFromLocalStorage() {
            const storedPathwayId = localStorage.getItem('selectedPathwayId');
            questionnaireState = {};

            if (storedPathwayId && pathData[storedPathwayId]) {
                selectPath(storedPathwayId);
            }
        }

        function selectPath(pathId) {
            document.querySelectorAll('.path-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.pathId === pathId);
            });
            selectedPathwayId = pathId;
            mainContent.classList.remove('hidden');
            analysisSection.classList.add('hidden'); // Always hide when path changes, will be shown if applicable
            renderChecklist(pathId);
            renderInfoPanel(pathId);

            isAssessmentSubmitted = false;
            downloadPdfBtn.disabled = true;
            downloadCustomerSummaryBtn.disabled = true;
            document.getElementById('download-checklist-pdf-btn').disabled = true;
            document.getElementById('download-analysis-pdf-btn').disabled = true;
            saveStateToLocalStorage();
            submissionId = generateUniqueSubmissionId();
            const submissionIdDisplay = document.getElementById('submission-id-display');
            if (submissionIdDisplay) {
                submissionIdDisplay.innerHTML = `<i class="fa-solid fa-id-badge mr-2"></i> Submission ID: <strong>${submissionId}</strong>`;
            }
        }

        function renderChecklist(pathId) {
            checklistContainer.innerHTML = '';
            if (pathId === 'path2') {
                renderBrownfieldQuestionnaire();
            } else if (pathId === 'path1') {
                renderGreenfieldQuestionnaire();
            } else if (pathId === 'path3') { // NEW: Handle Path 3
                renderVcfUpgradeQuestionnaire();
            }
            else {
                checklistTitle.textContent = `2. Readiness Checklist`;
                const emptyMessage = document.createElement('div');
                emptyMessage.className = "p-4 bg-blue-50 text-blue-800 rounded-md";
                emptyMessage.innerHTML = "Select a pathway to see the relevant checklist.";
                checklistContainer.appendChild(emptyMessage);
                questionnaireState = {}; 
            }
            saveStateToLocalStorage();
        }

        function renderGreenfieldQuestionnaire() {
            const path = pathData.path1;
            checklistTitle.textContent = `2. Greenfield Deployment Questionnaire`;
            checklistContainer.innerHTML = '';
            checklistContainer.appendChild(createQuestionnaireUI(path.greenfieldQuestions, 'greenfield'));
            questionnaireState = {}; 
            analysisSection.classList.remove('hidden'); 
        }

        function handleSubpathSelectionChange() {
            const path = pathData.path2;
            const specificContainer = document.getElementById('specific-questionnaire-container');
            const selectedSubPathKeys = Array.from(document.querySelectorAll('.subpath-checkbox:checked')).map(cb => cb.value);

            // Filter out old state from sub-paths no longer selected
            const newState = {};
            Object.keys(questionnaireState).forEach(key => {
                const prefix = key.split('-')[0];
                // Keep generic questions and questions from currently selected subpaths
                if (prefix === 'generic' || selectedSubPathKeys.includes(prefix)) {
                    newState[key] = questionnaireState[key];
                }
            });
            questionnaireState = newState;
            
            specificContainer.innerHTML = ''; // Clear previous questions

            if (selectedSubPathKeys.length === 0) {
                specificContainer.innerHTML = `<div class="p-4 bg-blue-50 text-blue-800 rounded-md">Please select a component mix to view relevant questions.</div>`;
            } else {
                selectedSubPathKeys.forEach(key => {
                    const subPath = path.subPaths[key];
                    if (subPath && subPath.questions && subPath.questions.length > 0) {
                        const subPathContainer = document.createElement('div');
                        subPathContainer.innerHTML = `<h4 class="text-lg font-bold text-gray-800 mb-2 border-b pb-2">${subPath.title}</h4>`;
                        subPathContainer.appendChild(createQuestionnaireUI(subPath.questions, key));
                        specificContainer.appendChild(subPathContainer);
                    }
                });
            }
            updateReadinessAnalysis();
            saveStateToLocalStorage();
        }


        function renderBrownfieldQuestionnaire() {
            const path = pathData.path2;
            checklistTitle.textContent = `2. Brownfield Readiness Questionnaire`;
            checklistContainer.innerHTML = '';

            const genericContainer = document.createElement('div');
            genericContainer.innerHTML = `<h3 class="text-xl font-semibold text-gray-800 mb-4">2A: Generic Questions (All Brownfield Paths)</h3>`;
            genericContainer.appendChild(createQuestionnaireUI(path.genericQuestions, 'generic'));
            checklistContainer.appendChild(genericContainer);

            const checkboxContainer = document.createElement('div');
            checkboxContainer.className = 'mt-8 p-4 border-t-2 border-gray-200';
            
            let checkboxesHtml = '';
            Object.keys(path.subPaths).forEach(key => {
                checkboxesHtml += `
                    <label class="flex items-center space-x-3 p-2 rounded-md hover:bg-gray-100 cursor-pointer">
                        <input type="checkbox" class="subpath-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" value="${key}">
                        <span class="text-gray-700 select-none">${path.subPaths[key].title}</span>
                    </label>
                `;
            });

            checkboxContainer.innerHTML = `
                <h3 class="text-xl font-semibold text-gray-800 mb-4">2B: Environment-Specific Questions</h3>
                <p class="text-sm text-gray-600 mb-4">Select all components present in the environment to see additional questions.</p>
                <div id="subpath-checkboxes" class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2">
                    ${checkboxesHtml}
                </div>
                <div id="specific-questionnaire-container" class="mt-6 space-y-6">
                     <div class="p-4 bg-blue-50 text-blue-800 rounded-md">Please select a component mix to view relevant questions.</div>
                </div>`;
            checklistContainer.appendChild(checkboxContainer);

            document.querySelectorAll('.subpath-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', handleSubpathSelectionChange);
            });
            
            // Restore checkbox state from localStorage
            const storedSubPaths = localStorage.getItem('selectedSubPaths');
            if (storedSubPaths) {
                try {
                    const selectedKeys = JSON.parse(storedSubPaths);
                    if (Array.isArray(selectedKeys)) {
                        selectedKeys.forEach(key => {
                            const checkbox = document.querySelector(`.subpath-checkbox[value="${key}"]`);
                            if (checkbox) {
                                checkbox.checked = true;
                            }
                        });
                        // Trigger the change handler to render questions for the loaded state
                        handleSubpathSelectionChange();
                    }
                } catch (e) {
                    console.error("Could not parse stored subpaths", e);
                }
            }

            analysisSection.classList.remove('hidden');
        }


        // NEW FUNCTION FOR PATH 3
        function renderVcfUpgradeQuestionnaire() {
            const path = pathData.path3;
            checklistTitle.textContent = `2. VCF 5.x to VCF 9.0 Upgrade Questionnaire`;
            checklistContainer.innerHTML = '';
            checklistContainer.appendChild(createQuestionnaireUI(path.vcfUpgradeQuestions, 'vcfUpgrade'));
            questionnaireState = {}; // Clears state for this path
            analysisSection.classList.remove('hidden'); // Show analysis section container, content updates on answer
        }

        function createQuestionnaireUI(questions, prefix) {
            const container = document.createElement('div');
            container.className = 'space-y-4';
            questions.forEach((q, index) => {
                const qDiv = document.createElement('div');
                qDiv.className = 'p-4 border border-gray-200 rounded-lg bg-white';

                let inputHtml = '';
                if (q.type === 'boolean') {
                    inputHtml = `
                        <div class="mt-3 flex items-center space-x-4" data-question-group="${q.id}">
                            <button data-answer="yes" class="answer-btn yes px-6 py-2 text-sm font-medium border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">Yes</button>
                            <button data-answer="no" class="answer-btn no px-6 py-2 text-sm font-medium border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">No</button>
                        </div>
                    `;
                } else if (q.type === 'select' && q.options) {
                    let optionsHtml = q.options.map(option => `<option value="${option.value}">${option.value}</option>`).join('');
                    inputHtml = `
                        <div class="mt-3" data-question-group="${q.id}">
                            <select class="answer-select mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="">-- Select an option --</option>
                                ${optionsHtml}
                            </select>
                        </div>
                    `;
                }

                qDiv.innerHTML = `<p class="font-medium text-gray-800">${index + 1}. ${q.text}</p>
                    ${inputHtml}
                    <div id="result-${prefix}-${q.id}" class="result-box mt-3 p-3 border-l-4 rounded-r-md text-sm hidden"></div>
                    <textarea id="note-${prefix}-${q.id}" class="notes-input mt-3 w-full text-sm p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="Add notes for this item..."></textarea>
                `;
                container.appendChild(qDiv);
            });

            container.querySelectorAll('.answer-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const clickedBtn = e.currentTarget;
                    const answer = clickedBtn.dataset.answer;
                    const groupDiv = clickedBtn.closest('[data-question-group]');
                    const questionId = groupDiv.dataset.questionGroup;
                    const questionData = questions.find(q => q.id === questionId);

                    const resultDiv = document.getElementById(`result-${prefix}-${questionId}`);

                    // Remove active/inactive classes from all buttons in the group
                    groupDiv.querySelectorAll('.answer-btn').forEach(b => {
                        b.classList.remove('active');
                        b.classList.add('inactive');
                    });
                    clickedBtn.classList.add('active');
                    clickedBtn.classList.remove('inactive');

                    const resultText = answer === 'yes' ? questionData.yes : questionData.no;

                    questionnaireState[`${prefix}-${questionId}`] = {
                        question: questionData.text,
                        answer: answer,
                        result: resultText,
                        category: questionData.category,
                        notes: document.getElementById(`note-${prefix}-${questionId}`).value
                    };

                    updateResultDisplay(resultDiv, resultText);
                    updateReadinessAnalysis(); // Update analysis content
                    isAssessmentSubmitted = false;
                    downloadPdfBtn.disabled = true;
                    downloadCustomerSummaryBtn.disabled = true;
                    document.getElementById('download-checklist-pdf-btn').disabled = true;
                    document.getElementById('download-analysis-pdf-btn').disabled = true;
                    saveStateToLocalStorage();
                });
            });

            container.querySelectorAll('.answer-select').forEach(selectElem => {
                selectElem.addEventListener('change', (e) => {
                    const selectedValue = e.target.value;
                    const groupDiv = e.target.closest('[data-question-group]');
                    const questionId = groupDiv.dataset.questionGroup;
                    const questionData = questions.find(q => q.id === questionId);

                    const resultDiv = document.getElementById(`result-${prefix}-${questionId}`);
                    let resultText = '';

                    if (selectedValue) {
                        const selectedOption = questionData.options.find(opt => opt.value === selectedValue);
                        if (selectedOption) {
                            resultText = selectedOption.result;
                        }
                    }

                    questionnaireState[`${prefix}-${questionId}`] = {
                        question: questionData.text,
                        answer: selectedValue, // The selected option value is the answer
                        result: resultText,
                        category: questionData.category,
                        notes: document.getElementById(`note-${prefix}-${questionId}`).value
                    };

                    if (selectedValue) {
                        updateResultDisplay(resultDiv, resultText);
                    } else {
                        resultDiv.classList.add('hidden'); // Hide if nothing selected
                    }
                    updateReadinessAnalysis(); // Update analysis content
                    isAssessmentSubmitted = false;
                    downloadPdfBtn.disabled = true;
                    downloadCustomerSummaryBtn.disabled = true;
                    document.getElementById('download-checklist-pdf-btn').disabled = true;
                    document.getElementById('download-analysis-pdf-btn').disabled = true;
                    saveStateToLocalStorage();
                });
            });


            container.querySelectorAll('.notes-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const id = e.target.id.replace('note-', '');
                    if (questionnaireState[id]) {
                        questionnaireState[id].notes = e.target.value;
                        isAssessmentSubmitted = false;
                        downloadPdfBtn.disabled = true;
                        downloadCustomerSummaryBtn.disabled = true;
                        document.getElementById('download-checklist-pdf-btn').disabled = true;
                        document.getElementById('download-analysis-pdf-btn').disabled = true;
                        saveStateToLocalStorage();
                    }
                });
            });

            return container;
        }

        function updateResultDisplay(resultDiv, resultText) {
            let caution = false, block = false;
            if (resultText.toLowerCase().includes('-- caution')) {
                caution = true;
                resultText = resultText.replace(/-- caution/i, '').trim();
            }
            // Updated condition for "Do Not Deploy" / blocker results
            if (resultText.toLowerCase().includes('cannot deploy') || resultText.toLowerCase().includes('update to') || resultText.toLowerCase().includes('upgrade aria operations for networks') || resultText.toLowerCase().includes('you cannot upgrade')) { block = true; }

            resultDiv.innerHTML = `<strong>Action/Result:</strong> ${resultText}`;
            resultDiv.classList.remove('hidden', 'caution', 'block', 'go');
            if (block) { resultDiv.classList.add('block'); }
            else if (caution) { resultDiv.classList.add('caution'); }
            else { resultDiv.classList.add('go'); }
        }


        function updateReadinessAnalysis() {
            const answeredQuestions = Object.values(questionnaireState);
            // Show readiness analysis section regardless of path, if questions are answered
            if (answeredQuestions.length === 0) {
                analysisSection.classList.add('hidden');
                return;
            }
            analysisSection.classList.remove('hidden');

            const summaryDiv = document.getElementById('readiness-summary');
            summaryDiv.innerHTML = generateReadinessSummary(answeredQuestions);
        }

        function generateReadinessSummary(answeredQuestions) {
            const blockers = [];
            const warnings = [];
            const goodToGo = [];

            answeredQuestions.forEach(q => {
                const resultText = q.result;
                const notes = q.notes ? `<div class="text-xs text-gray-500 pl-4 mt-1"><strong>Notes:</strong> ${q.notes}</div>` : '';

                // Clean the question text for the summary to remove "Yes or No", URLs, "Deploy VCF", and also "What Primary Storage will be used to deploy VCF 9.0?" for cleaner look
                let cleanedQuestionText = q.question.replace(/<span.*<\/span>/, '').replace(/ \(https:\/\/.*?\)/g, '').replace(/ Yes or No/g, '').trim();

                if (q.id === "gf-storage" && q.prefix === "greenfield") {
                    cleanedQuestionText = "Primary Storage used:"; // Simpler text for the summary
                } else {
                    // Remove common result phrases that might appear in original question text
                    cleanedQuestionText = cleanedQuestionText.replace(/Deploy VCF/g, '').replace(/Upgrade to VCF 9\.0/g, '').trim();
                }

                const itemHtml = `<li class="mb-3"><div class="font-semibold text-gray-800">${cleanedQuestionText}</div><div class="text-xs text-gray-600 pl-4"><strong>Action:</strong> ${resultText.replace(/-- caution/i, '')}</div>${notes}</li>`;

                // Updated condition for "Do Not Deploy" / blocker results
                if (resultText.toLowerCase().includes('cannot deploy') || resultText.toLowerCase().includes('update to') || resultText.toLowerCase().includes('upgrade aria operations for networks') || resultText.toLowerCase().includes('you cannot upgrade')) {
                    blockers.push(itemHtml);
                } else if (resultText.toLowerCase().includes('-- caution')) {
                    warnings.push(itemHtml);
                } else { // Covers "You can Deploy VCF 9.0", "You can upgrade to VCF 9.0" and other non-blocker/non-caution results
                    goodToGo.push(itemHtml);
                }
            });

            const createColumn = (title, items, colorClass, icon) => {
                if (items.length === 0) return '';
                return `
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-bold text-lg mb-3 flex items-center ${colorClass}">
                            <i class="${icon} mr-2"></i>
                            ${title}
                        </h4>
                        <ul class="space-y-3 text-sm">${items.join('')}</ul>
                    </div>
                `;
            };

            let html = '<div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-left">';
            html += createColumn(' Blockers (Must Fix)', blockers, 'text-red-600', 'fa-solid fa-ban');
            html += createColumn(' Warnings (Action Required)', warnings, 'text-amber-600', 'fa-solid fa-triangle-exclamation');
            html += createColumn(' Good to Go (No Action)', goodToGo, 'text-green-600', 'fa-solid fa-check-circle');
            html += '</div>';

            if (blockers.length > 0) {
                html = `<div class="p-4 mb-4 bg-red-100 border border-red-300 rounded-md text-red-800 text-center">
                            <h4 class="font-bold">Project Blocked!</h4>
                            <p>Your responses indicate at least one critical blocker. The project cannot proceed until all items in the "Blockers" column are resolved.</p>
                        </div>` + html;
            } else if (warnings.length === 0 && goodToGo.length > 0) {
                 html = `<div class="p-4 mb-4 bg-green-100 border border-green-300 rounded-md text-green-800 text-center">
                            <h4 class="font-bold">Great News!</h4>
                            <p>No critical blockers or warnings identified. Your environment appears ready for VCF 9.0 adoption.</p>
                        </div>` + html;
            }


            return html;
        }

        function renderInfoPanel(pathId) {
            const path = pathData[pathId];
            infoPanelContainer.innerHTML = '';

            const customerInfo = path.customer;
            const customerPanel = document.createElement('div');
            let customerDetailsHtml = customerInfo.details.map(detail => `<div class="flex items-start p-3 bg-blue-50/50 rounded-lg"><i class="${detail.icon} text-blue-600 text-xl mt-1 w-8 text-center"></i><p class="ml-3 text-sm text-gray-700">${detail.text}</p></div>`).join('');
            customerPanel.innerHTML = `<h3 class="text-xl font-bold text-blue-800 mb-3">${customerInfo.title}</h3><div class="space-y-3">${customerDetailsHtml}</div>`;
            infoPanelContainer.appendChild(customerPanel);

            infoPanelContainer.innerHTML += '<hr class="my-6 border-gray-300">';

            const deliveryInfo = path.delivery;
            const deliveryPanel = document.createElement('div');
            let deliveryDetailsHtml = deliveryInfo.sections.map(section => `<div><h4 class="text-lg font-semibold text-gray-700 mb-2 flex items-center"><i class="${section.icon} mr-3 text-gray-500"></i>${section.title}</h4><ul class="list-disc list-inside space-y-1 text-sm text-gray-600 pl-4">${section.items.map(item => `<li>${item}</li>`).join('')}</ul></div>`).join('');
            deliveryPanel.innerHTML = `<h3 class="text-xl font-bold text-gray-800 mb-3">${deliveryInfo.title}</h3><div class="space-y-4">${deliveryDetailsHtml}</div>`;
            infoPanelContainer.appendChild(deliveryPanel);
        }

        async function downloadPDF(elementId = 'printable-area', fileNamePrefix = 'VCF9_Readiness_Report') {
            if (!document.querySelector('.path-card.selected')) {
                alert('Please select a pathway before downloading.');
                return;
            }
            // Require answers for *any* path before allowing full report download, except for initial Greenfield
            if (Object.keys(questionnaireState).length === 0 && selectedPathwayId !== 'path1') {
                alert('Please answer at least one question before downloading this report.');
                return;
            }
            if (!isAssessmentSubmitted) {
                alert('Please click "Submit" to save your assessment before downloading any reports.');
                return;
            }

            if (elementId === 'readiness-analysis-section' && document.getElementById('readiness-analysis-section').classList.contains('hidden')) {
                alert('The Readiness Analysis section is not visible or has no content to download for the selected path or no questions have been answered yet.');
                return;
            }

            const originalDownloadPdfBtnText = downloadPdfBtnText.innerHTML;
            const originalDownloadPdfBtnDisabled = downloadPdfBtn.disabled;
            const originalDownloadCustomerSummaryBtnText = downloadCustomerSummaryBtnText.innerHTML;
            const originalDownloadCustomerSummaryBtnDisabled = downloadCustomerSummaryBtn.disabled;
            const originalSaveToSheetBtnText = document.getElementById('save-btn-text').innerHTML;
            const originalSaveToSheetBtnDisabled = saveToSheetBtn.disabled;
            const originalDownloadChecklistPdfBtnDisabled = document.getElementById('download-checklist-pdf-btn').disabled;
            const originalDownloadAnalysisPdfBtnDisabled = document.getElementById('download-analysis-pdf-btn').disabled;


            downloadPdfBtnText.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i>Generating...`;
            downloadPdfBtn.disabled = true;
            downloadCustomerSummaryBtn.disabled = true;
            saveToSheetBtn.disabled = true;
            document.getElementById('download-checklist-pdf-btn').disabled = true;
            document.getElementById('download-analysis-pdf-btn').disabled = true;


            const noPrintElements = document.querySelectorAll('.no-print');
            noPrintElements.forEach(el => el.classList.add('hide-for-pdf'));

            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const margin = 15;
                const contentWidth = pdfWidth - (margin * 2);

                const elementToCapture = document.getElementById(elementId);
                if (!elementToCapture) {
                    throw new Error(`Element with ID ${elementId} not found.`);
                }

                const canvas = await html2canvas(elementToCapture, {
                    scale: 3,
                    useCORS: true,
                    windowWidth: elementToCapture.scrollWidth,
                    windowHeight: elementToCapture.scrollHeight,
                    x: 0,
                    y: 0,
                    scrollX: 0,
                    scrollY: 0,
                });

                const imgData = canvas.toDataURL('image/jpeg', 1.0);
                const imgHeight = canvas.height * contentWidth / canvas.width;
                let heightLeft = imgHeight;

                let position = 0;

                pdf.addImage(imgData, 'JPEG', margin, margin, contentWidth, imgHeight);
                heightLeft -= pdfHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', margin, position + margin, contentWidth, imgHeight);
                    heightLeft -= pdfHeight;
                }

                const customerName = document.getElementById('customer-name').value.trim() || 'Untitled_Assessment';
                const sanitizedCustomerName = customerName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                // Include submissionId in the PDF filename for better tracking
                const pdfFileName = `${fileNamePrefix}_${sanitizedCustomerName}_${submissionId}.pdf`;
                pdf.save(pdfFileName);

            } catch (error) {
                console.error("Error generating PDF:", error);
                alert("Sorry, an error occurred while generating the PDF. Please check the console for details.");
            } finally {
                noPrintElements.forEach(el => el.classList.remove('hide-for-pdf'));
                downloadPdfBtn.disabled = originalDownloadPdfBtnDisabled;
                downloadCustomerSummaryBtn.disabled = originalDownloadCustomerSummaryBtnDisabled;
                saveToSheetBtn.disabled = originalSaveToSheetBtnDisabled;
                downloadPdfBtnText.innerHTML = originalDownloadPdfBtnText;
                downloadCustomerSummaryBtnText.innerHTML = originalDownloadCustomerSummaryBtnText;
                document.getElementById('save-btn-text').innerHTML = originalSaveToSheetBtnText;
                document.getElementById('download-checklist-pdf-btn').disabled = originalDownloadChecklistPdfBtnDisabled;
                document.getElementById('download-analysis-pdf-btn').disabled = originalDownloadAnalysisPdfBtnDisabled;
            }
        }

        async function downloadCustomerSummary() {
            if (!document.querySelector('.path-card.selected')) {
                alert('Please select a pathway before downloading.');
                return;
            }
            if (Object.keys(questionnaireState).length === 0 && selectedPathwayId !== 'path1') {
                alert('Please answer at least one question before generating the summary.');
                return;
            }
            if (!isAssessmentSubmitted) {
                alert('Please click "Submit" to save your assessment before downloading any reports.');
                return;
            }


            const originalDownloadCustomerSummaryBtnText = downloadCustomerSummaryBtnText.innerHTML;
            const originalDownloadCustomerSummaryBtnDisabled = downloadCustomerSummaryBtn.disabled;
            const originalDownloadPdfBtnText = downloadPdfBtnText.innerHTML;
            const originalDownloadPdfBtnDisabled = downloadPdfBtn.disabled;
            const originalSaveToSheetBtnText = document.getElementById('save-btn-text').innerHTML;
            const originalSaveToSheetBtnDisabled = saveToSheetBtn.disabled;
            const originalDownloadChecklistPdfBtnDisabled = document.getElementById('download-checklist-pdf-btn').disabled;
            const originalDownloadAnalysisPdfBtnDisabled = document.getElementById('download-analysis-pdf-btn').disabled;

            downloadCustomerSummaryBtnText.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i>Generating...`;
            downloadPdfBtn.disabled = true;
            downloadCustomerSummaryBtn.disabled = true;
            saveToSheetBtn.disabled = true;
            document.getElementById('download-checklist-pdf-btn').disabled = true;
            document.getElementById('download-analysis-pdf-btn').disabled = true;


            try {
                const customerName = document.getElementById('customer-name').value.trim();
                const selectedPath = pathData[selectedPathwayId];

                let selectedComponentMixText = 'N/A';
                if (selectedPathwayId === 'path2') {
                    const checked = Array.from(document.querySelectorAll('.subpath-checkbox:checked'));
                    if (checked.length > 0) {
                        selectedComponentMixText = checked.map(cb => pathData.path2.subPaths[cb.value].title).join(', ');
                    }
                }

                let summaryContent = `VCF 9.0 Adoption Readiness Application Summary\n`;
                summaryContent += `Customer Name: ${customerName || 'N/A'}\n`;
                summaryContent += `Assessed By: ${USER_EMAIL || 'N/A'}\n`;
                summaryContent += `Submission ID: ${submissionId || 'N/A'}\n`; // Include Submission ID here
                summaryContent += `Date: ${new Date().toLocaleDateString()}\n`;
                summaryContent += `===========================================================\n\n`;
                summaryContent += `Selected Pathway: ${selectedPath.title}\n`;
                summaryContent += `Description: ${selectedPath.description}\n`;
                if (selectedPathwayId === 'path2') { // Only show component mix for brownfield
                    summaryContent += `Selected Component Mix (Brownfield only): ${selectedComponentMixText}\n\n`;
                } else {
                    summaryContent += `\n`;
                }


                summaryContent += `--- Customer Considerations for ${selectedPath.title} ---\n`;
                selectedPath.customer.details.forEach(detail => {
                    const plainText = detail.text.replace(/<[^>]*>/g, '').replace('&nbsp;', ' ').trim();
                    summaryContent += `* ${plainText}\n`;
                });
                summaryContent += `\n`;

                summaryContent += `--- Delivery Considerations for ${selectedPath.title} ---\n`;
                selectedPath.delivery.sections.forEach(section => {
                    summaryContent += `  ${section.title}:\n`;
                    section.items.forEach(item => {
                        summaryContent += `   - ${item}\n`;
                    });
                });
                summaryContent += `\n`;

                // Add Readiness Analysis details for selected path
                if (Object.keys(questionnaireState).length > 0) { // Only add if questions have been answered
                    const blockers = [];
                    const warnings = [];
                    const goodToGo = [];

                    Object.values(questionnaireState).forEach(q => {
                        let resultText = q.result.replace(/-- caution/i, '').trim();
                        let notes = q.notes ? ` (Notes: ${q.notes})` : '';

                        // Clean the question text for the summary to remove "Yes or No", URLs, "Deploy VCF", and also "What Primary Storage will be used to deploy VCF 9.0?" for cleaner look
                        let cleanedQuestionText = q.question.replace(/<span.*<\/span>/, '').replace(/ \(https:\/\/.*?\)/g, '').replace(/ Yes or No/g, '').trim();
                        if (q.id === "gf-storage" && q.prefix === "greenfield") {
                            cleanedQuestionText = "Primary Storage used:"; // Simpler text for the summary
                        } else {
                            // Remove common result phrases that might appear in original question text
                            cleanedQuestionText = cleanedQuestionText.replace(/Deploy VCF/g, '').replace(/Upgrade to VCF 9\.0/g, '').trim();
                        }

                        const item = `- ${cleanedQuestionText}\n  Action/Result: ${resultText}${notes}\n`;

                        // Updated condition for "Do Not Deploy" / blocker results
                        if (resultText.toLowerCase().includes('cannot deploy') || resultText.toLowerCase().includes('update to') || resultText.toLowerCase().includes('upgrade aria operations for networks') || resultText.toLowerCase().includes('you cannot upgrade')) {
                            blockers.push(item);
                        } else if (q.result.toLowerCase().includes('-- caution')) {
                            warnings.push(item);
                        } else { // Covers "You can Deploy VCF 9.0", "You can upgrade to VCF 9.0" and other non-blocker/non-caution results
                            goodToGo.push(item);
                        }
                    });

                    summaryContent += `--- Readiness Analysis Details ---\n\n`;

                    if (blockers.length > 0) {
                        summaryContent += ` BLOCKERS (MUST BE RESOLVED BEFORE PROCEEDING):\n`;
                        summaryContent += `=================================================\n`;
                        blockers.forEach(item => summaryContent += item + '\n');
                        summaryContent += `\n`;
                    } else {
                        summaryContent += ` No critical blockers identified at this stage.\n\n`;
                    }

                    if (warnings.length > 0) {
                        summaryContent += ` WARNINGS / ACTIONS REQUIRED:\n`;
                        summaryContent += `===============================\n`;
                        warnings.forEach(item => summaryContent += item + '\n');
                        summaryContent += `These items require attention and remediation but do not necessarily block the project if managed.\n\n`;
                    } else {
                        summaryContent += ` No specific warnings or immediate actions identified.\n\n`;
                    }

                    if (goodToGo.length > 0) {
                        summaryContent += ` ITEMS GOOD TO GO:\n`;
                        summaryContent += `====================\n`;
                        goodToGo.forEach(item => summaryContent += item + '\n');
                        summaryContent += `These items indicate compatibility or readiness for VCF 9.0.\n\n`;
                    }
                } else { // No questions answered for this path
                    summaryContent += `--- Readiness Analysis Details ---\n\n`;
                    summaryContent += `No questions have been answered for the selected path yet. Please answer questions to see readiness details.\n\n`;
                }

                summaryContent += `===========================================================\n`;
                summaryContent += `This summary is based on the information provided in the assessment tool.\n`;
                summaryContent += `For detailed planning and implementation, please consult with VMware experts.\n`;

                const blob = new Blob([summaryContent], { type: 'text/plain;charset=utf-8' });
                const customerFileName = customerName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                const txtFileName = `VCF9_Readiness_Summary_${customerFileName}_${submissionId}.txt`; // Include submissionId in filename
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = txtFileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

            } catch (error) {
                console.error("Error generating Customer Summary:", error);
                alert("Sorry, an error occurred while generating the customer summary. Please check the console for details.");
            } finally {
                downloadPdfBtn.disabled = originalDownloadPdfBtnDisabled;
                downloadCustomerSummaryBtn.disabled = originalDownloadCustomerSummaryBtnDisabled;
                saveToSheetBtn.disabled = originalSaveToSheetBtnDisabled;
                downloadPdfBtnText.innerHTML = originalDownloadPdfBtnText;
                downloadCustomerSummaryBtnText.innerHTML = originalDownloadCustomerSummaryBtnText;
                document.getElementById('save-btn-text').innerHTML = originalSaveToSheetBtnText;
                document.getElementById('download-checklist-pdf-btn').disabled = originalDownloadChecklistPdfBtnDisabled;
                document.getElementById('download-analysis-pdf-btn').disabled = originalDownloadAnalysisPdfBtnDisabled;
            }
        }

        function saveDataToSheet() {
            const saveBtn = document.getElementById('save-to-sheet-btn');
            const saveBtnText = document.getElementById('save-btn-text');
            const saveIcon = document.getElementById('save-icon');

            const selectedPathCard = document.querySelector('.path-card.selected');
            if (!selectedPathCard) { alert('Please select a pathway before saving.'); return; }
            if (Object.keys(questionnaireState).length === 0 && selectedPathwayId !== 'path1') { // Path1 can be saved even if no questions (info only)
                 alert('Please answer at least one question before saving.');
                 return;
            }


            // Ensure a submission ID exists before saving
            if (!submissionId) {
                submissionId = generateUniqueSubmissionId();
                const submissionIdDisplay = document.getElementById('submission-id-display');
                if (submissionIdDisplay) {
                    submissionIdDisplay.innerHTML = `<i class="fa-solid fa-id-badge mr-2"></i> Submission ID: <strong>${submissionId}</strong>`;
                }
            }

            saveBtn.disabled = true;
            downloadPdfBtn.disabled = true;
            downloadCustomerSummaryBtn.disabled = true;
            document.getElementById('download-checklist-pdf-btn').disabled = true;
            document.getElementById('download-analysis-pdf-btn').disabled = true;
            saveBtnText.textContent = "Saving...";
            saveIcon.className = "fa-solid fa-spinner fa-spin mr-2";

            const customerName = document.getElementById('customer-name').value.trim() || 'N/A';
            const pathTitle = selectedPathCard.querySelector('h3').textContent;

            let selectedSubPathTitles = 'N/A'; // Only relevant for Brownfield
            if (selectedPathwayId === 'path2') {
                const checked = Array.from(document.querySelectorAll('.subpath-checkbox:checked'));
                if (checked.length > 0) {
                    selectedSubPathTitles = checked.map(cb => pathData.path2.subPaths[cb.value].title).join(', ');
                }
            }

            let totalScore = 0, maxScore = 0, hasBlocker = false;
            Object.values(questionnaireState).forEach(q => {
                    const resultText = q.result.toLowerCase();
                // Updated condition for "Do Not Deploy" / blocker results
                if (resultText.includes('cannot deploy') || resultText.includes('update to') || resultText.includes('upgrade aria operations for networks') || resultText.includes('you cannot upgrade')) {
                    hasBlocker = true;
                } else if (resultText.includes('-- caution')) {
                    totalScore += 1;
                } else {
                    totalScore += 2;
                }
                maxScore += 2;
            });

            const score = hasBlocker ? 0 : (maxScore > 0 ? Math.round((totalScore / maxScore) * 100) : 100);

            const payload = {
                submissionId: submissionId, // Pass the generated ID to the backend
                customerName: customerName,
                pathTitle: pathTitle,
                selectedSubPathTitle: selectedSubPathTitles,
                score: score,
                details: questionnaireState
            };

            google.script.run
                .withSuccessHandler(onSaveSuccess)
                .withFailureHandler(onSaveFailure)
                .saveAssessmentData(payload);
        }

        function onSaveSuccess(message) {
            const saveBtn = document.getElementById('save-to-sheet-btn');
            const saveBtnText = document.getElementById('save-btn-text');
            const saveIcon = document.getElementById('save-icon');

            saveBtnText.textContent = "Saved!";
            saveIcon.className = "fa-solid fa-check mr-2";

            isAssessmentSubmitted = true;
            downloadPdfBtn.disabled = false;
            downloadCustomerSummaryBtn.disabled = false;
            document.getElementById('download-checklist-pdf-btn').disabled = false;
            document.getElementById('download-analysis-pdf-btn').disabled = false;

            setTimeout(() => {
                saveBtn.disabled = false;
                saveBtnText.textContent = "Submit";
                saveIcon.className = "fa-solid fa-cloud-upload mr-2";
            }, 3000);
        }

        function onSaveFailure(error) {
            const saveBtn = document.getElementById('save-to-sheet-btn');
            const saveBtnText = document.getElementById('save-btn-text');
            const saveIcon = document.getElementById('save-icon');

            alert('Error saving data: ' + error.message);
            saveBtn.disabled = false;
            downloadPdfBtn.disabled = !isAssessmentSubmitted;
            downloadCustomerSummaryBtn.disabled = !isAssessmentSubmitted;
            document.getElementById('download-checklist-pdf-btn').disabled = !isAssessmentSubmitted;
            document.getElementById('download-analysis-pdf-btn').disabled = !isAssessmentSubmitted;
            saveBtnText.textContent = "Submit";
            saveIcon.className = "fa-solid fa-cloud-upload mr-2";
        }

        document.addEventListener('DOMContentLoaded', () => {
            initialize();
            loadStateFromLocalStorage();
        });
    </script>
</body>
</html>

